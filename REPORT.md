# Отчёт о разработке банковской системы

##  Цель проекта

Разработать модульную банковскую систему на Go для исследования влияния архитектурных решений на производительность. Система проходит через 4 этапа оптимизации с замерами RPS (requests per second), Latency и потребления ресурсов после каждого шага.

### Основные задачи:
- Реализовать базовый REST API для банковских операций
- Обеспечить безопасность через JWT-аутентификацию
- Измерить производительность на каждом этапе
- Провести сравнительный анализ различных архитектурных подходов

---
##  Бизнес-правила

### Пользователи
- Уникальное имя пользователя
- Пароль хешируется с помощью bcrypt (cost=10)
- JWT токен действителен 24 часа

### Счета
- Номер счёта: 14 цифр (префикс "13" + 12 случайных)
- Системный счёт банка: `00000000000001`
- Начальный баланс: 100.00
- Максимум 5 активных счетов на пользователя
- Статусы: `active`, `closed`

### Транзакции
- **Transfer (перевод):** комиссия 1%
- **Payment (платёж):** комиссия 3%
- Все комиссии идут на системный счёт `00000000000001`
- Атомарность операций через DB-транзакции
- Невозможно перевести больше, чем есть на счету

### Безопасность
- JWT токены в заголовке `Authorization: Bearer <token>`
- Пользователь может работать только со своими счетами
- Нельзя удалить чужой счёт
- Нельзя списать с чужого счёта

---

##  Стек технологий

### Backend
- **Go 1.21+** - основной язык программирования
- **fasthttp** - HTTP-сервер
- **PostgreSQL 16** - база данных
- **pgx/v5** - драйвер PostgreSQL
- **golang-migrate** - миграции БД
- **JWT (golang-jwt/jwt/v4)** - аутентификация
- **bcrypt** - хеширование паролей

### Инфраструктура
- **Docker & Docker Compose** - контейнеризация
  - Изолированное окружение
  - Простое развёртывание
  - Воспроизводимая среда

### Тестирование
- **k6** - нагрузочное тестирование
  - Симуляция реальной нагрузки
  - Детальная статистика
  - Различные сценарии тестирования

---


### Принципы работы слоёв:

1. **Handlers** - принимают HTTP-запросы, валидируют входные данные
2. **Services** - реализуют бизнес-логику (расчёт комиссий, проверки прав)
3. **Repository** - выполняют SQL-запросы, изолируют БД от остальных слоёв
4. **Models** - определяют структуры данных для всей системы

---

##  Установка и запуск

### Предварительные требования
- Docker и Docker Compose
- Go 1.21+ (для локальной разработки)
- Git

### Шаг 1: Клонирование репозитория
```bash
git clone 
cd bank-prototype
```

### Шаг 2: Запуск с помощью Docker Compose
```bash

docker-compose up -d
docker-compose logs -f app
```

### Шаг 3: Запуск с помощью скрипта
```bash
chmod +x start-server.sh
./start-server.sh
```

### Шаг 4: Проверка работоспособности
```bash
curl http://localhost:8080/health
```

Ответ:
```json
{
  "status": "OK",
  "timestamp": "2025-12-26T10:30:00Z"
}
```

### Остановка сервера
```bash
docker-compose down
```

### Полная очистка (включая данные БД)
```bash
docker-compose down -v
```

---

##  API документация

### Базовый URL
```
http://localhost:8080
```

### Формат ответов
Все ответы возвращаются в формате JSON.

### Коды ответов
- `200 OK` - успешная операция
- `201 Created` - ресурс создан
- `400 Bad Request` - ошибка валидации
- `401 Unauthorized` - требуется аутентификация
- `403 Forbidden` - недостаточно прав
- `500 Internal Server Error` - ошибка сервера

---

##  Эндпоинты API

### 1. Health Check

Проверка работоспособности сервера.

**Запрос:**
```
GET /health
```
- Method: `GET`
- URL: `http://localhost:8080/health`
- Headers: не требуются
- Body: не требуется

**Ответ:**
```json
{
  "status": "OK",
  "timestamp": "2025-12-26T10:30:00Z"
}
```

---

### 2. Регистрация пользователя

Создание нового пользователя в системе.

**Запрос:**


- Method: `POST`
- URL: `http://localhost:8080/register`
- Headers:
  - `Content-Type: application/json`
- Body (raw JSON):
```json
{
  "name": "john_doe",
  "password": "SecurePass123!"
}
```

**Успешный ответ (201 Created):**
```json
{
  "user_id": "550e8400-e29b-41d4-a716-446655440000",
  "name": "john_doe"
}
```

**Ошибки:**
- `400` - имя пользователя уже занято
- `400` - некорректные данные (пустое имя/пароль)

---

### 3. Вход в систему

Аутентификация пользователя и получение JWT токена.

**Запрос:**
```
POST /login
Content-Type: application/json

{
  "name": "john_doe",
  "password": "SecurePass123!"
}
```

**Пример в Postman:**
- Method: `POST`
- URL: `http://localhost:8080/login`
- Headers:
  - `Content-Type: application/json`
- Body (raw JSON):
```json
{
  "name": "john_doe",
  "password": "SecurePass123!"
}
```

**Успешный ответ (200 OK):**
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**Ошибки:**
- `401` - неверное имя пользователя или пароль

Полученный токен необходимо использовать для всех последующих запросов в заголовке `Authorization`.

---

### 4. Создание счёта

Создание нового банковского счёта для пользователя.

**Пример в Postman:**
- Method: `POST`
- URL: `http://localhost:8080/accounts`
- Headers:
  - `Content-Type: application/json`
  - `Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...`
- Body: не требуется (или пустой JSON `{}`)

**Успешный ответ (201 Created):**
```json
{
  "account_id": "13579246801234",
  "balance": "100.00",
  "status": "active"
}
```

**Ошибки:**
- `400` - превышен лимит счетов (максимум 5 активных)
- `401` - отсутствует или невалидный токен

---

### 5. Получение списка счетов

Получение всех счетов текущего пользователя.

**Пример в Postman:**
- Method: `GET`
- URL: `http://localhost:8080/accounts`
- Headers:
  - `Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...`
- Body: не требуется

**Успешный ответ (200 OK):**
```json
{
  "accounts": [
    {
      "id": "13579246801234",
      "balance": "100.00",
      "status": "active",
      "created_at": "2025-12-26T10:30:00Z"
    },
    {
      "id": "13987654321098",
      "balance": "250.50",
      "status": "active",
      "created_at": "2025-12-26T11:00:00Z"
    },
    {
      "id": "13111222333444",
      "balance": "0.00",
      "status": "closed",
      "created_at": "2025-12-25T09:00:00Z"
    }
  ]
}
```

**Ошибки:**
- `401` - отсутствует или невалидный токен

Возвращаются все счета пользователя, включая закрытые.

---

### 6. Закрытие счёта

Закрытие банковского счёта (перевод в статус "closed").

**Пример в Postman:**
- Method: `DELETE`
- URL: `http://localhost:8080/accounts/13579246801234`
- Headers:
  - `Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...`
- Body: не требуется

**Успешный ответ (200 OK):**
```json
{
  "message": "Account closed successfully"
}
```

**Ошибки:**
- `400` - счёт уже закрыт
- `400` - недостаточно средств для перевода остатка
- `401` - отсутствует или невалидный токен
- `403` - попытка закрыть чужой счёт

При закрытии счёта весь остаток переводится на системный счёт банка `00000000000001`.

---

### 7. Удаление пользователя

Полное удаление пользователя и всех его счетов из системы.


**Пример в Postman:**
- Method: `DELETE`
- URL: `http://localhost:8080/users`
- Headers:
  - `Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...`
- Body: не требуется

**Успешный ответ (200 OK):**
```json
{
  "message": "User deleted successfully"
}
```

**Ошибки:**
- `401` - отсутствует или невалидный токен
- `500` - ошибка при удалении

**Примечание:** Все счета пользователя также удаляются (CASCADE).

---

### 8. Перевод между счетами

Перевод денег с одного счёта на другой с комиссией 1%.

**Запрос:**

- Method: `POST`
- URL: `http://localhost:8080/transactions`
- Headers:
  - `Content-Type: application/json`
  - `Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...`
- Body (raw JSON):
```json
{
  "from_account_id": "13579246801234",
  "to_account_id": "13987654321098",
  "amount": 100.00,
  "type": "transfer"
}
```

**Успешный ответ (201 Created):**
```json
{
  "transaction_id": "750e8400-e29b-41d4-a716-446655440000",
  "from_account_id": "13579246801234",
  "to_account_id": "13987654321098",
  "amount": "100.00",
  "fee_amount": "1.00",
  "total_debit": "101.00",
  "type": "transfer",
  "status": "completed"
}
```

**Расчёт комиссии:**
- Комиссия: 1% от суммы
- Списано с отправителя: 100.00 + 1.00 = 101.00
- Зачислено получателю: 100.00
- Комиссия на системный счёт: 1.00

**Ошибки:**
- `400` - недостаточно средств
- `400` - счёт закрыт
- `400` - некорректная сумма (≤ 0)
- `401` - отсутствует или невалидный токен
- `403` - попытка списать с чужого счёта

---

### 9. Платёж

Платёж со счёта с комиссией 3%.

**Запрос:**


**Пример в Postman:**
- Method: `POST`
- URL: `http://localhost:8080/transactions`
- Headers:
  - `Content-Type: application/json`
  - `Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...`
- Body (raw JSON):
```json
{
  "from_account_id": "13579246801234",
  "to_account_id": "13987654321098",
  "amount": 100.00,
  "type": "payment"
}
```

**Успешный ответ (201 Created):**
```json
{
  "transaction_id": "850e8400-e29b-41d4-a716-446655440000",
  "from_account_id": "13579246801234",
  "to_account_id": "13987654321098",
  "amount": "100.00",
  "fee_amount": "3.00",
  "total_debit": "103.00",
  "type": "payment",
  "status": "completed"
}
```

**Расчёт комиссии:**
- Комиссия: 3% от суммы
- Списано с плательщика: 100.00 + 3.00 = 103.00
- Зачислено получателю: 100.00
- Комиссия на системный счёт: 3.00

**Ошибки:** аналогичны переводу

---


### Логирование

Сервер выводит цветные логи для всех операций:

-  **Зелёный** - успешные операции (CREATE, GET)
-  **Синий** - информационные сообщения
-  **Жёлтый** - предупреждения
-  **Красный** - ошибки

Пример лога:
```
2025/12/26 10:30:15 [CREATE] User registered: alice (ID: 550e8400-e29b-41d4-a716-446655440000)
2025/12/26 10:30:20 [GET] User alice retrieved accounts: 1 active, 0 closed
2025/12/26 10:30:25 [CREATE] Transfer completed: 50.00 from 13579246801234 to 13987654321098
```

---

##  Нагрузочное тестирование

### Установка k6

k6 уже установлен в системе (версия 0.48.0).

### Запуск тестов

```bash
cd ~/bank-prototype/load-tests
./run-tests.sh
```


##  Результаты замеров


#### 1. Smoke Test (1 минута)

**Цель:** Базовая проверка функциональности системы

**Конфигурация:**
- Виртуальные пользователи: 1 VU
- Продолжительность: 1 мин 4.5 сек
- Итераций: 48

**Результаты:**
-  Успешность проверок: **90%** (432 успешных, 48 неудачных)
-  Средняя задержка: **53.58 ms**
-  P95 задержка: **147.96 ms**
-  Запросов в секунду: **3.72 req/s**
-  Ошибок: **0%**
-  Всего запросов: 240

Неудачные проверки связаны с валидацией ID счёта (формат ответа), функциональность работает корректно.

---

#### 2. Load Test (18 минут)

**Цель:** Проверка системы под нормальной нагрузкой

**Конфигурация:**
- Виртуальные пользователи: 0→10→20→30 (постепенное увеличение)
- Продолжительность: 19 мин 5.7 сек
- Итераций: 11,264
- Предварительно созданных пользователей: 20 с активными счетами

**Результаты:**
-  Успешность проверок: **100%** (11,264 успешных)
-  Средняя задержка: **3.5 ms**
-  P95 задержка: **3.43 ms**
-  P99 задержка: не превышает порога
-  Запросов в секунду: **9.88 req/s** (порог: 100 req/s)
-  Ошибок: **0%**
-  Всего запросов: 11,324


---

#### 3. Stress Test (21 минута)

**Цель:** Проверка пределов системы под высокой нагрузкой

**Конфигурация:**
- Виртуальные пользователи: 0→20→50→100→250 (агрессивное увеличение)
- Продолжительность: 22 мин 17.1 сек
- Итераций: 111,920
- Предварительно созданных пользователей: 20 с активными счетами

**Результаты:**
- Успешность проверок: **100%** (111,920 успешных)
- Средняя задержка: **2.52 ms**
- P95 задержка: **3.26 ms**
-  Max задержка: **1 секунда** (единичный случай)
- Запросов в секунду: **83.75 req/s**
-  Ошибок: **0%**
-  Всего запросов: 111,980

**Выводы:** Система показывает отличную стабильность даже при 250 одновременных пользователях. Задержки остаются низкими.

---

#### 4. Spike Test (2.5 минуты)

**Цель:** Проверка поведения при резком скачке нагрузки

**Конфигурация:**
- Виртуальные пользователи: 10→200 за 30 секунд → 300 за 1 минуту
- Продолжительность: 2 мин 47.5 сек
- Итераций: 65,600
- Предварительно созданных пользователей: 30 с активными счетами

**Результаты:**
-  Успешность проверок: **100%** (131,200 успешных)
-  Средняя задержка: **2.95 ms**
-  P95 задержка: **8.85 ms**
-  Max задержка: **2.28 секунды** (пиковая нагрузка)
-  Запросов в секунду: **783.89 req/s** 
-  Ошибок: **0%**
-  Всего запросов: 131,290



---

#### 5. Full Scenario (12 минут)

**Цель:** Комплексное тестирование реального рабочего сценария

**Конфигурация:**
- 3 параллельных сценария:
  - Регистрация пользователей: 0→3→5 VU
  - Банковские операции: 0→10→45→10 VU
  - Чтение данных: 15 VU 
- Продолжительность: 12 мин 43.4 сек
- Итераций: 15,584

**Результаты:**
- Успешность проверок: **100%** (71 проверка)
-  Средняя задержка: **59.91 ms**
-  P95 задержка: **131.85 ms**
-  Max задержка: **1.16 секунды**
-  Запросов в секунду: **1.05 req/s** (комбинированный сценарий)
-  Ошибок: **0%**
-  Всего запросов: 800
-  Итераций в секунду: **20.41 iter/s**


---

### Результаты базовой версии (БЕЗ кеширования)

| Метрика | Smoke | Load | Stress | Spike | Full |
|---------|-------|------|--------|-------|------|
| **Avg Response Time** | 53.58 ms | 3.5 ms | 2.52 ms | 2.95 ms | 59.91 ms |
| **P90 Response Time** | 117.18 ms | 2.75 ms | 2.78 ms | 5.59 ms | 98.19 ms |
| **P95 Response Time** | 147.96 ms | 3.43 ms | 3.26 ms | 8.85 ms | 131.85 ms |
| **Max Response Time** | 538.55 ms | 1.21 s | 1 s | 2.28 s | 1.16 s |
| **Total Requests** | 240 | 11,324 | 111,980 | 131,290 | 800 |
| **Requests/sec** | 3.72 | 9.88 | 83.75 | **783.89** | 1.05 |
| **Error Rate** | 0% | 0% | 0% | 0% | 0% |
| **Check Success** | 90% | 100% | 100% | 100% | 100% |
| **Max VUs** | 1 | 50 | 250 | 300 | 60 |
| **Duration** | 1m 4s | 19m 6s | 22m 17s | 2m 48s | 12m 43s |

---

##  Оптимизация с Redis

### Внедрённые изменения
- **Redis 7.4** для кеширования данных счетов и балансов
- TTL для кеша: балансы - 60 сек, списки счетов - 300 сек
- Инвалидация кеша при изменении данных

### Результаты с Redis кешированием

| Метрика | Smoke | Load | Stress | Spike | Full |
|---------|-------|------|--------|-------|------|
| **Avg Response Time** | 62.73 ms | 6.41 ms | 114.41 ms | 21.93 ms | 94.13 ms |
| **P90 Response Time** | 135.94 ms | 2.76 ms | 160.9 ms | 29.61 ms | 170.77 ms |
| **P95 Response Time** | 160.4 ms | 6.04 ms | 553.31 ms | 62.49 ms | 227.29 ms |
| **Max Response Time** | 943.89 ms | 6.36 s | 11.29 s | 2.43 s | 1.2 s |
| **Total Requests** | 235 | 32,891 | 263,924 | 116,528 | 762 |
| **Requests/sec** | 3.73 | 28.95 | 196.22 | **702.39** | 1.01 |
| **Error Rate** | 0% | 0% | 0% | 0% | 0% |
| **Check Success** | 90% | 100% | 100% | 100% | 100% |
| **Max VUs** | 1 | 150 | 500 | 300 | 60 |
| **Duration** | 1m 3s | 18m 56s | 22m 27s | 2m 46s | 12m 33s |

### Сравнение производительности

| Метрика | Load (без/с Redis) | Stress (без/с Redis) | Spike (без/с Redis) |
|---------|-------------------|---------------------|---------------------|
| **RPS** | 9.88 → **28.95** (+193%) | 83.75 → **196.22** (+134%) | 783.89 → **702.39** (-10%) |
| **Обработано запросов** | 11,324 → **32,891** (+190%) | 111,980 → **263,924** (+136%) | 131,290 → **116,528** (-11%) |
| **Max VUs** | 50 → **150** (x3) | 250 → **500** (x2) | 300 (без изменений) |
| **Avg Response Time** | 3.5 ms → 6.41 ms (+83%) | 2.52 ms → 114.41 ms (+4441%) | 2.95 ms → 21.93 ms (+643%) |

### Выводы по Redis

 **Преимущества Redis:**
- **Load Test:** пропускная способность выросла на **193%** при увеличенной нагрузке (150 VU vs 50 VU)
- **Stress Test:** система обрабатывает на **136% больше** запросов при удвоенной нагрузке (500 VU vs 250 VU)
- **Снижение нагрузки на БД:** повторные запросы счетов обслуживаются из кеша (видно в логах: "HIT")

 **Особенности:**
- **Spike Test:** небольшое снижение (-10%) связано с холодным кешем при резких скачках нагрузки
- **Латентность:** рост задержек при экстремальных нагрузках (500 VU) из-за сетевых операций Redis
- **Стабильность:** 0% ошибок при всех сценариях, включая 500 одновременных пользователей

---

##  Оптимизация с Worker Pool

### Внедрённые изменения
- **Worker Pool** с 100 горутинами для асинхронной обработки транзакций
- Канал задач с буфером 1000 для балансировки нагрузки
- Комбинация с Redis кешированием для максимальной производительности

### Результаты с Worker Pool + Redis

| Метрика | Smoke | Load | Stress | Spike | Full |
|---------|-------|------|--------|-------|------|
| **Avg Response Time** | 57.87 ms | 6.82 ms | 65.31 ms | 7.07 ms | 49.22 ms |
| **P90 Response Time** | 126.76 ms | 2.8 ms | 23.6 ms | 16.7 ms | 80.78 ms |
| **P95 Response Time** | 146.73 ms | 6.53 ms | 136.7 ms | 31.49 ms | 90.8 ms |
| **Max Response Time** | 794.41 ms | 1.15 s | 8.93 s | 937.31 ms | 780.44 ms |
| **Total Requests** | 235 | 32,887 | 272,329 | 127,568 | 786 |
| **Requests/sec** | 3.69 | **28.86** | **203.97** | **755.20** | 1.04 |
| **Error Rate** | 0% | 0% | 0% | 0% | 0% |
| **Check Success** | 90% | 100% | 100% | 100% | 100% |
| **Max VUs** | 1 | 150 | **500** | 300 | 60 |
| **Duration** | 1m 4s | 19m 0s | 22m 15s | 2m 49s | 12m 34s |

### Итоговое сравнение всех конфигураций

| Тест | Базовый API | + Redis | + Worker Pool | Улучшение |
|------|-------------|---------|---------------|-----------|
| **Load (req/s)** | 9.88 | 28.95 | 28.86 | **+192%** |
| **Stress (req/s)** | 83.75 | 196.22 | 203.97 | **+144%** |
| **Stress Max VUs** | 250 | 500 | 500 | **+100%** |
| **Spike (req/s)** | 783.89 | 702.39 | 755.20 | **-4%** |

### Выводы по Worker Pool

**Ключевые результаты:**
- **Stress Test:** стабильная работа с 500 VUs при 204 req/s (против 250 VUs в базовой версии)
- **Load Test:** производительность ~29 req/s сохранена без деградации
- **Spike Test:** небольшое улучшение до 755 req/s благодаря параллельной обработке

**Worker Pool обеспечивает:**
- Асинхронную обработку транзакций через канал задач
- Пул из 100 горутин-воркеров для параллельного выполнения
- Защиту от перегрузки при высоких нагрузках
- Стабильность работы под экстремальными нагрузками (500 VUs)

**Комбинация Redis + Worker Pool:**
- Redis снижает нагрузку на БД через кеширование чтения
- Worker Pool обеспечивает параллельную обработку записей
- Вместе дают **2.4x ускорение** и **2x увеличение** допустимой нагрузки



